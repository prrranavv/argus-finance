<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1600 1200">
<!-- Statement Processing Flow Sequence Diagram -->
<text x="10" y="30" font-family="Arial" font-size="16" font-weight="bold">Statement Processing Flow - File Upload to Database</text>

<!-- Participants -->
<rect x="50" y="60" width="120" height="40" fill="#e3f2fd" stroke="#1976d2" stroke-width="2" rx="5"/>
<text x="110" y="85" text-anchor="middle" font-family="Arial" font-size="12" font-weight="bold">User</text>

<rect x="220" y="60" width="120" height="40" fill="#f3e5f5" stroke="#7b1fa2" stroke-width="2" rx="5"/>
<text x="280" y="85" text-anchor="middle" font-family="Arial" font-size="12" font-weight="bold">Frontend UI</text>

<rect x="390" y="60" width="150" height="40" fill="#fff3e0" stroke="#ef6c00" stroke-width="2" rx="5"/>
<text x="465" y="85" text-anchor="middle" font-family="Arial" font-size="12" font-weight="bold">/api/process-statement</text>

<rect x="590" y="60" width="120" height="40" fill="#e8f5e8" stroke="#2e7d32" stroke-width="2" rx="5"/>
<text x="650" y="85" text-anchor="middle" font-family="Arial" font-size="12" font-weight="bold">Supabase Storage</text>

<rect x="760" y="60" width="120" height="40" fill="#fce4ec" stroke="#c2185b" stroke-width="2" rx="5"/>
<text x="820" y="85" text-anchor="middle" font-family="Arial" font-size="12" font-weight="bold">Supabase DB</text>

<rect x="930" y="60" width="120" height="40" fill="#f1f8e9" stroke="#689f38" stroke-width="2" rx="5"/>
<text x="990" y="85" text-anchor="middle" font-family="Arial" font-size="12" font-weight="bold">OpenAI GPT-4</text>

<rect x="1100" y="60" width="120" height="40" fill="#e0f2f1" stroke="#00695c" stroke-width="2" rx="5"/>
<text x="1160" y="85" text-anchor="middle" font-family="Arial" font-size="12" font-weight="bold">File Processor</text>

<!-- Lifelines -->
<line x1="110" y1="100" x2="110" y2="1100" stroke="#666" stroke-width="2" stroke-dasharray="5,5"/>
<line x1="280" y1="100" x2="280" y2="1100" stroke="#666" stroke-width="2" stroke-dasharray="5,5"/>
<line x1="465" y1="100" x2="465" y2="1100" stroke="#666" stroke-width="2" stroke-dasharray="5,5"/>
<line x1="650" y1="100" x2="650" y2="1100" stroke="#666" stroke-width="2" stroke-dasharray="5,5"/>
<line x1="820" y1="100" x2="820" y2="1100" stroke="#666" stroke-width="2" stroke-dasharray="5,5"/>
<line x1="990" y1="100" x2="990" y2="1100" stroke="#666" stroke-width="2" stroke-dasharray="5,5"/>
<line x1="1160" y1="100" x2="1160" y2="1100" stroke="#666" stroke-width="2" stroke-dasharray="5,5"/>

<!-- Messages -->
<defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" 
            refX="10" refY="3.5" orient="auto">
        <polygon points="0 0, 10 3.5, 0 7" fill="#333" />
    </marker>
</defs>

<!-- Step 1: File Upload -->
<line x1="110" y1="140" x2="280" y2="140" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
<text x="150" y="135" font-family="Arial" font-size="11">Upload Statement File (CSV, PDF, Excel)</text>

<line x1="280" y1="160" x2="465" y2="160" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
<text x="300" y="155" font-family="Arial" font-size="11">POST /api/process-statement (FormData)</text>

<!-- Step 2: Authentication -->
<rect x="370" y="180" width="200" height="30" fill="#ffeb3b" stroke="#f57f17" stroke-width="1" rx="5"/>
<text x="470" y="200" text-anchor="middle" font-family="Arial" font-size="11" font-weight="bold">Authentication Check</text>

<line x1="465" y1="220" x2="820" y2="220" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
<text x="580" y="215" font-family="Arial" font-size="11">Verify user session</text>

<line x1="820" y1="240" x2="465" y2="240" stroke="#333" stroke-width="2" stroke-dasharray="3,3" marker-end="url(#arrowhead)"/>
<text x="580" y="235" font-family="Arial" font-size="11">User authenticated</text>

<!-- Step 3: Duplicate Check -->
<rect x="370" y="260" width="200" height="30" fill="#ffeb3b" stroke="#f57f17" stroke-width="1" rx="5"/>
<text x="470" y="280" text-anchor="middle" font-family="Arial" font-size="11" font-weight="bold">Duplicate Check</text>

<line x1="465" y1="300" x2="820" y2="300" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
<text x="500" y="295" font-family="Arial" font-size="11">Check for existing file (name, size, hash)</text>

<line x1="820" y1="320" x2="465" y2="320" stroke="#333" stroke-width="2" stroke-dasharray="3,3" marker-end="url(#arrowhead)"/>
<text x="580" y="315" font-family="Arial" font-size="11">No duplicate found</text>

<!-- Step 4: File Upload to Storage -->
<rect x="370" y="340" width="200" height="30" fill="#ffeb3b" stroke="#f57f17" stroke-width="1" rx="5"/>
<text x="470" y="360" text-anchor="middle" font-family="Arial" font-size="11" font-weight="bold">File Upload</text>

<line x1="465" y1="380" x2="650" y2="380" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
<text x="480" y="375" font-family="Arial" font-size="11">Upload to storage/statements</text>

<line x1="650" y1="400" x2="465" y2="400" stroke="#333" stroke-width="2" stroke-dasharray="3,3" marker-end="url(#arrowhead)"/>
<text x="520" y="395" font-family="Arial" font-size="11">File URL returned</text>

<!-- Step 5: Database Record -->
<rect x="370" y="420" width="200" height="30" fill="#ffeb3b" stroke="#f57f17" stroke-width="1" rx="5"/>
<text x="470" y="440" text-anchor="middle" font-family="Arial" font-size="11" font-weight="bold">Database Record</text>

<line x1="465" y1="460" x2="820" y2="460" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
<text x="480" y="455" font-family="Arial" font-size="11">INSERT INTO statements</text>
<text x="480" y="470" font-family="Arial" font-size="10">{file_name, file_type, file_size, file_hash, file_url, user_id}</text>

<line x1="820" y1="490" x2="465" y2="490" stroke="#333" stroke-width="2" stroke-dasharray="3,3" marker-end="url(#arrowhead)"/>
<text x="580" y="485" font-family="Arial" font-size="11">Statement record created</text>

<!-- Step 6: AI Processing -->
<rect x="370" y="510" width="200" height="30" fill="#ffeb3b" stroke="#f57f17" stroke-width="1" rx="5"/>
<text x="470" y="530" text-anchor="middle" font-family="Arial" font-size="11" font-weight="bold">AI Processing</text>

<line x1="465" y1="550" x2="1160" y2="550" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
<text x="700" y="545" font-family="Arial" font-size="11">processFinancialStatement(file)</text>

<line x1="1160" y1="570" x2="1160" y2="580" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
<text x="1170" y="585" font-family="Arial" font-size="10">extractTextFromFile()</text>
<text x="1170" y="600" font-family="Arial" font-size="9">• CSV: direct text</text>
<text x="1170" y="615" font-family="Arial" font-size="9">• PDF: pdfreader library</text>
<text x="1170" y="630" font-family="Arial" font-size="9">• Excel: xlsx library</text>

<line x1="1160" y1="650" x2="990" y2="650" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
<text x="1020" y="645" font-family="Arial" font-size="11">OpenAI Chat Completion</text>
<text x="1020" y="660" font-family="Arial" font-size="10">System: TRANSACTION_EXTRACTION</text>
<text x="1020" y="675" font-family="Arial" font-size="10">Content: extracted text</text>

<line x1="990" y1="690" x2="1160" y2="690" stroke="#333" stroke-width="2" stroke-dasharray="3,3" marker-end="url(#arrowhead)"/>
<text x="1010" y="685" font-family="Arial" font-size="11">Structured JSON response</text>
<text x="1010" y="700" font-family="Arial" font-size="10">{transactions: [{date, description, amount, type, category, bankName...}]}</text>

<line x1="1160" y1="720" x2="465" y2="720" stroke="#333" stroke-width="2" stroke-dasharray="3,3" marker-end="url(#arrowhead)"/>
<text x="700" y="715" font-family="Arial" font-size="11">ProcessedStatement {transactions[], summary}</text>

<!-- Step 7: Duplicate Prevention -->
<rect x="370" y="740" width="200" height="30" fill="#ffeb3b" stroke="#f57f17" stroke-width="1" rx="5"/>
<text x="470" y="760" text-anchor="middle" font-family="Arial" font-size="11" font-weight="bold">Duplicate Prevention</text>

<rect x="350" y="780" width="240" height="60" fill="#e8eaf6" stroke="#3f51b5" stroke-width="1" rx="5"/>
<text x="470" y="800" text-anchor="middle" font-family="Arial" font-size="11">For each transaction:</text>
<text x="370" y="815" font-family="Arial" font-size="10">Check for duplicate transaction</text>
<text x="370" y="830" font-family="Arial" font-size="10">(date, description, amount, bank_name)</text>

<!-- Step 8: Bulk Insert -->
<rect x="370" y="850" width="200" height="30" fill="#ffeb3b" stroke="#f57f17" stroke-width="1" rx="5"/>
<text x="470" y="870" text-anchor="middle" font-family="Arial" font-size="11" font-weight="bold">Bulk Insert</text>

<line x1="465" y1="890" x2="820" y2="890" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
<text x="500" y="885" font-family="Arial" font-size="11">INSERT INTO all_transactions (unique transactions only)</text>

<line x1="820" y1="910" x2="465" y2="910" stroke="#333" stroke-width="2" stroke-dasharray="3,3" marker-end="url(#arrowhead)"/>
<text x="580" y="905" font-family="Arial" font-size="11">Transactions inserted</text>

<!-- Step 9: Balance Calculation -->
<line x1="465" y1="930" x2="820" y2="930" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
<text x="500" y="925" font-family="Arial" font-size="11">INSERT/UPDATE balances table</text>

<line x1="820" y1="950" x2="465" y2="950" stroke="#333" stroke-width="2" stroke-dasharray="3,3" marker-end="url(#arrowhead)"/>
<text x="580" y="945" font-family="Arial" font-size="11">Balances updated</text>

<!-- Step 10: Mark Processed -->
<line x1="465" y1="970" x2="820" y2="970" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
<text x="500" y="965" font-family="Arial" font-size="11">UPDATE statements SET processed = true</text>

<line x1="820" y1="990" x2="465" y2="990" stroke="#333" stroke-width="2" stroke-dasharray="3,3" marker-end="url(#arrowhead)"/>
<text x="580" y="985" font-family="Arial" font-size="11">Statement marked processed</text>

<!-- Final Response -->
<line x1="465" y1="1010" x2="280" y2="1010" stroke="#333" stroke-width="2" stroke-dasharray="3,3" marker-end="url(#arrowhead)"/>
<text x="300" y="1005" font-family="Arial" font-size="11">Success response {transactionCount, metadata}</text>

<line x1="280" y1="1030" x2="110" y2="1030" stroke="#333" stroke-width="2" stroke-dasharray="3,3" marker-end="url(#arrowhead)"/>
<text x="130" y="1025" font-family="Arial" font-size="11">Processing complete - Show transaction count</text>

<!-- Footer -->
<text x="50" y="1150" font-family="Arial" font-size="12" fill="#666">
AI-Powered Processing • Duplicate Prevention • Multi-format Support • Real-time Feedback
</text>
</svg> 