<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1400 1000">
<!-- Authentication & Security Flow -->
<text x="10" y="30" font-family="Arial" font-size="16" font-weight="bold">Authentication & Security Flow - JWT, RLS, and User Data Isolation</text>

<!-- Authentication Flow Section -->
<rect x="50" y="60" width="1300" height="350" fill="#e3f2fd" stroke="#1976d2" stroke-width="2" rx="10"/>
<text x="700" y="90" text-anchor="middle" font-family="Arial" font-size="14" font-weight="bold">Authentication Flow</text>

<!-- Participants -->
<rect x="80" y="120" width="100" height="50" fill="#fff3e0" stroke="#ef6c00" stroke-width="2" rx="5"/>
<text x="130" y="150" text-anchor="middle" font-family="Arial" font-size="12" font-weight="bold">User</text>

<rect x="220" y="120" width="120" height="50" fill="#f3e5f5" stroke="#7b1fa2" stroke-width="2" rx="5"/>
<text x="280" y="150" text-anchor="middle" font-family="Arial" font-size="12" font-weight="bold">Next.js Frontend</text>

<rect x="380" y="120" width="120" height="50" fill="#e8f5e8" stroke="#2e7d32" stroke-width="2" rx="5"/>
<text x="440" y="150" text-anchor="middle" font-family="Arial" font-size="12" font-weight="bold">Supabase Auth</text>

<rect x="540" y="120" width="120" height="50" fill="#fce4ec" stroke="#c2185b" stroke-width="2" rx="5"/>
<text x="600" y="150" text-anchor="middle" font-family="Arial" font-size="12" font-weight="bold">Supabase DB</text>

<rect x="700" y="120" width="120" height="50" fill="#f1f8e9" stroke="#689f38" stroke-width="2" rx="5"/>
<text x="760" y="150" text-anchor="middle" font-family="Arial" font-size="12" font-weight="bold">Backend APIs</text>

<!-- Lifelines -->
<line x1="130" y1="170" x2="130" y2="380" stroke="#666" stroke-width="1" stroke-dasharray="3,3"/>
<line x1="280" y1="170" x2="280" y2="380" stroke="#666" stroke-width="1" stroke-dasharray="3,3"/>
<line x1="440" y1="170" x2="440" y2="380" stroke="#666" stroke-width="1" stroke-dasharray="3,3"/>
<line x1="600" y1="170" x2="600" y2="380" stroke="#666" stroke-width="1" stroke-dasharray="3,3"/>
<line x1="760" y1="170" x2="760" y2="380" stroke="#666" stroke-width="1" stroke-dasharray="3,3"/>

<!-- Authentication Messages -->
<defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" 
            refX="10" refY="3.5" orient="auto">
        <polygon points="0 0, 10 3.5, 0 7" fill="#333" />
    </marker>
</defs>

<line x1="130" y1="200" x2="280" y2="200" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
<text x="150" y="195" font-family="Arial" font-size="11">Access Dashboard</text>

<line x1="280" y1="220" x2="440" y2="220" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
<text x="300" y="215" font-family="Arial" font-size="11">Check session</text>

<line x1="440" y1="240" x2="280" y2="240" stroke="#333" stroke-width="2" stroke-dasharray="3,3" marker-end="url(#arrowhead)"/>
<text x="320" y="235" font-family="Arial" font-size="11">No valid session</text>

<line x1="280" y1="260" x2="130" y2="260" stroke="#333" stroke-width="2" stroke-dasharray="3,3" marker-end="url(#arrowhead)"/>
<text x="160" y="255" font-family="Arial" font-size="11">Show Auth Modal</text>

<line x1="130" y1="280" x2="280" y2="280" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
<text x="150" y="275" font-family="Arial" font-size="11">Enter credentials</text>

<line x1="280" y1="300" x2="440" y2="300" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
<text x="300" y="295" font-family="Arial" font-size="11">signIn(email, password)</text>

<line x1="440" y1="320" x2="280" y2="320" stroke="#333" stroke-width="2" stroke-dasharray="3,3" marker-end="url(#arrowhead)"/>
<text x="320" y="315" font-family="Arial" font-size="11">JWT token + session</text>

<line x1="280" y1="340" x2="280" y2="350" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
<text x="290" y="355" font-family="Arial" font-size="11">Store session in cookies</text>

<!-- Security Features -->
<rect x="850" y="120" width="480" height="290" fill="#f8f9fa" stroke="#6c757d" stroke-width="2" rx="8"/>
<text x="1090" y="145" text-anchor="middle" font-family="Arial" font-size="14" font-weight="bold">Security Features</text>

<text x="870" y="170" font-family="Arial" font-size="12" font-weight="bold">üîê JWT Tokens:</text>
<text x="870" y="190" font-family="Arial" font-size="11">‚Ä¢ Secure, stateless authentication</text>
<text x="870" y="205" font-family="Arial" font-size="11">‚Ä¢ Automatic expiration handling</text>
<text x="870" y="220" font-family="Arial" font-size="11">‚Ä¢ Stored in secure HTTP-only cookies</text>

<text x="870" y="245" font-family="Arial" font-size="12" font-weight="bold">üõ°Ô∏è Row Level Security (RLS):</text>
<text x="870" y="265" font-family="Arial" font-size="11">‚Ä¢ Users can only see their own data</text>
<text x="870" y="280" font-family="Arial" font-size="11">‚Ä¢ Database-level security enforcement</text>
<text x="870" y="295" font-family="Arial" font-size="11">‚Ä¢ Automatic filtering on all queries</text>

<text x="870" y="320" font-family="Arial" font-size="12" font-weight="bold">üîí Session Management:</text>
<text x="870" y="340" font-family="Arial" font-size="11">‚Ä¢ Automatic refresh token handling</text>
<text x="870" y="355" font-family="Arial" font-size="11">‚Ä¢ Secure logout and session cleanup</text>
<text x="870" y="370" font-family="Arial" font-size="11">‚Ä¢ Cross-tab synchronization</text>

<text x="870" y="395" font-family="Arial" font-size="12" font-weight="bold">üö´ Authorization:</text>

<!-- Row Level Security Section -->
<rect x="50" y="430" width="1300" height="480" fill="#e8f5e8" stroke="#2e7d32" stroke-width="2" rx="10"/>
<text x="700" y="460" text-anchor="middle" font-family="Arial" font-size="14" font-weight="bold">Row Level Security (RLS) Implementation</text>

<!-- Request Flow -->
<rect x="80" y="490" width="100" height="50" fill="#fff3e0" stroke="#ef6c00" stroke-width="2" rx="5"/>
<text x="130" y="520" text-anchor="middle" font-family="Arial" font-size="12" font-weight="bold">User</text>

<rect x="220" y="490" width="120" height="50" fill="#f3e5f5" stroke="#7b1fa2" stroke-width="2" rx="5"/>
<text x="280" y="520" text-anchor="middle" font-family="Arial" font-size="12" font-weight="bold">Frontend</text>

<rect x="380" y="490" width="120" height="50" fill="#f1f8e9" stroke="#689f38" stroke-width="2" rx="5"/>
<text x="440" y="520" text-anchor="middle" font-family="Arial" font-size="12" font-weight="bold">API</text>

<rect x="540" y="490" width="120" height="50" fill="#fce4ec" stroke="#c2185b" stroke-width="2" rx="5"/>
<text x="600" y="520" text-anchor="middle" font-family="Arial" font-size="12" font-weight="bold">Database</text>

<!-- RLS Lifelines -->
<line x1="130" y1="540" x2="130" y2="850" stroke="#666" stroke-width="1" stroke-dasharray="3,3"/>
<line x1="280" y1="540" x2="280" y2="850" stroke="#666" stroke-width="1" stroke-dasharray="3,3"/>
<line x1="440" y1="540" x2="440" y2="850" stroke="#666" stroke-width="1" stroke-dasharray="3,3"/>
<line x1="600" y1="540" x2="600" y2="850" stroke="#666" stroke-width="1" stroke-dasharray="3,3"/>

<!-- RLS Flow -->
<line x1="130" y1="570" x2="280" y2="570" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
<text x="150" y="565" font-family="Arial" font-size="11">Request transactions</text>

<line x1="280" y1="590" x2="440" y2="590" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
<text x="300" y="585" font-family="Arial" font-size="11">GET /api/all-transactions</text>
<text x="300" y="600" font-family="Arial" font-size="10">Cookie: supabase-auth-token</text>

<line x1="440" y1="620" x2="440" y2="630" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
<text x="450" y="635" font-family="Arial" font-size="11">Verify session from cookie</text>

<line x1="440" y1="650" x2="440" y2="660" stroke="#333" stroke-width="2" stroke-dasharray="3,3" marker-end="url(#arrowhead)"/>
<text x="450" y="665" font-family="Arial" font-size="11">User ID: 'user123'</text>

<line x1="440" y1="680" x2="600" y2="680" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
<text x="460" y="675" font-family="Arial" font-size="11">SELECT * FROM all_transactions</text>
<text x="460" y="690" font-family="Arial" font-size="11">WHERE user_id = 'user123'</text>

<!-- RLS Policy Box -->
<rect x="700" y="590" width="600" height="200" fill="#fff3e0" stroke="#ef6c00" stroke-width="2" rx="5"/>
<text x="1000" y="615" text-anchor="middle" font-family="Arial" font-size="12" font-weight="bold">RLS Policy Applied</text>
<text x="720" y="640" font-family="Arial" font-size="11" font-weight="bold">Policy Name:</text>
<text x="720" y="655" font-family="Arial" font-size="11">"Users can only see their own data"</text>

<text x="720" y="680" font-family="Arial" font-size="11" font-weight="bold">SQL Policy:</text>
<text x="720" y="695" font-family="Arial" font-size="10">CREATE POLICY "user_isolation_policy"</text>
<text x="720" y="710" font-family="Arial" font-size="10">ON all_transactions</text>
<text x="720" y="725" font-family="Arial" font-size="10">FOR ALL</text>
<text x="720" y="740" font-family="Arial" font-size="10">USING (user_id = auth.uid());</text>

<text x="720" y="765" font-family="Arial" font-size="11" font-weight="bold">Result:</text>
<text x="720" y="780" font-family="Arial" font-size="11">‚Ä¢ Database automatically filters results</text>

<line x1="600" y1="720" x2="440" y2="720" stroke="#333" stroke-width="2" stroke-dasharray="3,3" marker-end="url(#arrowhead)"/>
<text x="480" y="715" font-family="Arial" font-size="11">Filtered results for user123 only</text>

<line x1="440" y1="740" x2="280" y2="740" stroke="#333" stroke-width="2" stroke-dasharray="3,3" marker-end="url(#arrowhead)"/>
<text x="320" y="735" font-family="Arial" font-size="11">User's transactions only</text>

<line x1="280" y1="760" x2="130" y2="760" stroke="#333" stroke-width="2" stroke-dasharray="3,3" marker-end="url(#arrowhead)"/>
<text x="160" y="755" font-family="Arial" font-size="11">Display personal data</text>

<!-- Additional Security Features -->
<rect x="80" y="790" width="580" height="100" fill="#e8eaf6" stroke="#3f51b5" stroke-width="2" rx="5"/>
<text x="370" y="815" text-anchor="middle" font-family="Arial" font-size="12" font-weight="bold">Additional Security Measures</text>

<text x="100" y="840" font-family="Arial" font-size="11">üîê <tspan font-weight="bold">JWT tokens</tspan> for authentication</text>
<text x="100" y="855" font-family="Arial" font-size="11">üõ°Ô∏è <tspan font-weight="bold">Row Level Security (RLS)</tspan> on all tables</text>
<text x="100" y="870" font-family="Arial" font-size="11">üë§ <tspan font-weight="bold">User ID filtering</tspan> on every query</text>

<text x="350" y="840" font-family="Arial" font-size="11">üîí <tspan font-weight="bold">Server-side session</tspan> validation</text>
<text x="350" y="855" font-family="Arial" font-size="11">üç™ <tspan font-weight="bold">Secure cookie</tspan> storage</text>
<text x="350" y="870" font-family="Arial" font-size="11">üö´ <tspan font-weight="bold">Unauthorized requests</tspan> rejected with 401</text>

<!-- Data Isolation Example -->
<rect x="700" y="810" width="600" height="80" fill="#e0f2f1" stroke="#00695c" stroke-width="2" rx="5"/>
<text x="1000" y="835" text-anchor="middle" font-family="Arial" font-size="12" font-weight="bold">Data Isolation Example</text>
<text x="720" y="855" font-family="Arial" font-size="11">User A (user123): Can only access their 156 transactions</text>
<text x="720" y="870" font-family="Arial" font-size="11">User B (user456): Can only access their 89 transactions</text>

<text x="50" y="970" font-family="Arial" font-size="12" fill="#666">
JWT Authentication ‚Ä¢ Row Level Security ‚Ä¢ User Data Isolation ‚Ä¢ Secure Session Management ‚Ä¢ Database-Level Security
</text>
</svg> 